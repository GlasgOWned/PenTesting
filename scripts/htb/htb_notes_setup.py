#!/usr/share/env python3

from pathlib import Path
import argparse
import subprocess
import shlex

parser = argparse.ArgumentParser()
parser.add_argument("-n", "--name", type=str, help="the machine name")
parser.add_argument("-i", "--ip", type=str, help="the machine's ip address")
parser.add_argument("--nmap", action="store_true", help="perform nmap scan")
parser.add_argument("--hosts", action="store_true", help="add entry to /etc/hosts")

args = parser.parse_args()

p = Path().home() / "Documents/htb/boxes" / args.name

if not p.exists():
    print(f"creating folder: {p}")
    p.mkdir(parents=True, exist_ok=True)

if args.nmap:
    print(f"performing nmap scan of {args.ip}")
    nmap_command = shlex.split(f"nmap -T5 {args.ip}")
    nmap_output = subprocess.run(nmap_command, capture_output=True).stdout.decode().strip()
    print(nmap_output)
else:
    nmap_output = ""

if args.hosts:
    print(f"\nadding entry to /etc/hosts")
    host_entry = f"{args.ip}\t{args.name}.htb\n"
    cmd = shlex.split(f"sudo tee -a /etc/hosts")
    # to do - add return code check
    subprocess.run(cmd, input=host_entry.encode())

notes_text = f"# {args.name.title()}\nip: {args.ip}\n\nnmap:\n```\n{nmap_output}\n```\n"
(p / f"{args.name}_notes.md").write_text(notes_text)

print("\ndone... happy hacking!")
